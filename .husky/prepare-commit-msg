#!/usr/bin/env sh

COMMIT_MSG_FILE=$1

# Read only the first line (header)
HEADER=$(head -n 1 "$COMMIT_MSG_FILE")

# Only process if header doesn't already contain an emoji
if ! echo "$HEADER" | grep -qE "^\w+\([^)]*[ðŸ˜€-ðŸ™]\)"; then
  TYPE=$(echo "$HEADER" | grep -oE "^[a-z]+")
  
  case "$TYPE" in
    feat)     EMOJI="âœ¨" ;;
    fix)      EMOJI="ðŸ›" ;;
    chore)    EMOJI="ðŸ”§" ;;
    docs)     EMOJI="ðŸ“" ;;
    refactor) EMOJI="â™»ï¸" ;;
    test)     EMOJI="âœ…" ;;
    build)    EMOJI="ðŸ“¦" ;;
    ci)       EMOJI="ðŸ‘·" ;;
    perf)     EMOJI="âš¡" ;;
    style)    EMOJI="ðŸ’„" ;;
    *)        EMOJI="" ;;
  esac

  if [ -n "$EMOJI" ]; then
    if echo "$HEADER" | grep -qE "^\w+\([^)]+\):"; then
      NEW_HEADER=$(echo "$HEADER" | sed -E "s/^([a-z]+)\(([^)]+)\):/\1(\2-$EMOJI):/")
    else
      NEW_HEADER=$(echo "$HEADER" | sed -E "s/^([a-z]+):/\1($EMOJI):/")
    fi

    # Replace only the first line, keep the body intact
    tail -n +2 "$COMMIT_MSG_FILE" | sed "1s/.*/$NEW_HEADER/" > "$COMMIT_MSG_FILE.tmp"
    mv "$COMMIT_MSG_FILE.tmp" "$COMMIT_MSG_FILE"
  fi
fi
